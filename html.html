<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llanterama Tulancingo - Sistema de Inteligencia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .bg-llanterama { background: radial-gradient(circle at top, #002d5a 0%, #001f3f 100%); }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .card-current { background: #fefce8; border: 2px solid #eab308 !important; }
        .shadow-pro { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .linea-pro { border-left: 8px solid #003366; } .linea-lub { border-left: 8px solid #f97316; }
        .linea-moto { border-left: 8px solid #ef4444; } .linea-filt { border-left: 8px solid #22c55e; }
        .linea-alc { border-left: 8px solid #8b5cf6; } .linea-rec { border-left: 8px solid #94a3b8; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Colores especiales para zonas enumeradas */
        .zona-badge { background: #eab308; color: #001f3f; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 900; font-style: italic; margin-right: 12px; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-llanterama z-50 flex flex-col items-center justify-center text-white text-center p-6">
        <div class="w-10 h-10 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-[9px] font-bold tracking-[0.3em] uppercase opacity-50 italic underline">Conectando Llanterama</p>
        <button id="retry-btn" onclick="location.reload()" class="hidden mt-4 bg-yellow-500 text-blue-900 px-6 py-2 rounded-full text-xs font-black uppercase">Reintentar</button>
    </div>

    <div id="view-cover" class="fixed inset-0 bg-llanterama z-40 flex flex-col items-center justify-center text-center p-8 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none">
            <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-500 rounded-full blur-[120px]"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-yellow-500 rounded-full blur-[120px]"></div>
        </div>
        <div class="relative z-10 fade-in">
            <div class="mb-2">
                <span class="text-yellow-400 font-black tracking-[0.4em] uppercase text-[10px]">Bienvenido a</span>
            </div>
            <h1 class="text-6xl font-black text-white italic tracking-tighter leading-none mb-2 uppercase">LLANTERAMA</h1>
            <p class="text-yellow-500 font-bold tracking-widest text-xs mb-8 uppercase">Tulancingo • Inteligencia Comercial</p>
            
            <div class="glass px-6 py-4 rounded-2xl mb-12 max-w-xs mx-auto text-center">
                <p class="text-[11px] text-blue-100 font-medium leading-relaxed opacity-80">
                    Acceso restringido para personal autorizado.
                </p>
            </div>
            <button onclick="enterApp()" class="group bg-white text-blue-950 font-black px-16 py-4 rounded-full shadow-2xl uppercase tracking-widest text-xs transition-all hover:bg-yellow-400 active:scale-95">
                Entrar al Sistema <i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <header id="main-header" class="bg-llanterama text-white p-5 sticky top-0 z-30 shadow-xl border-b-4 border-yellow-500 hidden">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div onclick="location.reload()" class="cursor-pointer">
                <h1 class="text-xl font-black italic leading-none uppercase">Llanterama</h1>
                <p class="text-[8px] font-bold text-yellow-400 tracking-widest uppercase">Panel de Control</p>
            </div>
            <button onclick="renderAnalytics()" class="bg-white/10 p-2 rounded-xl border border-white/20 text-yellow-400">
                <i class="fas fa-chart-line"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">
        <div id="content-area" class="space-y-4"></div>
    </main>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRA2Ijt1TI5_APzSJNjdlGF1_Jex0-n3iTiy8R996VR6PNx6V7tM8xO8u3sFKwp2A/pub?gid=1217270027&single=true&output=csv';
        let db = [];
        const mesesRef = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

        async function start() {
            try {
                const response = await fetch(CSV_URL + '&cb=' + Date.now());
                const text = await response.text();
                Papa.parse(text, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        db = results.data.filter(r => r.MES && r.AÑO);
                        document.getElementById('loader').classList.add('hidden');
                    }
                });
            } catch (e) { document.getElementById('retry-btn').classList.remove('hidden'); }
        }

        function enterApp() {
            document.getElementById('view-cover').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            renderPeriods();
        }

        function renderPeriods() {
            const sortedPeriods = [...new Set(db.map(r => `${r.MES} ${r.AÑO}`))].sort((a, b) => {
                const [mesA, anoA] = a.split(' '), [mesB, anoB] = b.split(' ');
                return anoA !== anoB ? anoB - anoA : mesesRef.indexOf(mesB) - mesesRef.indexOf(mesA);
            });
            let html = `<h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-2">Seleccione Periodo</h2>`;
            sortedPeriods.forEach((p, idx) => {
                const isCurrent = idx === 0;
                html += `<button onclick="selectMonth('${p}')" class="w-full bg-white p-5 rounded-2xl shadow-pro flex justify-between items-center mb-3 ${isCurrent ? 'card-current' : ''} fade-in text-left border-l-4 border-blue-900">
                    <div><p class="font-black text-blue-900 uppercase italic text-lg tracking-tighter">${p}</p></div>
                    <i class="fas fa-chevron-right text-slate-200"></i></button>`;
            });
            document.getElementById('content-area').innerHTML = html;
        }

        function selectMonth(p) {
            const [m, a] = p.split(' ');
            renderZones(db.filter(r => r.MES === m && r.AÑO === a), p);
        }

        // ZONAS ENUMERADAS Y SIN UTILIDAD
        function renderZones(data, period) {
            const zones = [...new Set(data.map(r => r.ZONA))];
            let html = `<button onclick="renderPeriods()" class="text-blue-900 font-black text-[10px] mb-6 uppercase flex items-center"><i class="fas fa-arrow-left mr-2"></i> Regresar</button>
                        <h2 class="text-2xl font-black text-slate-800 mb-6 uppercase italic">${period}</h2>`;
            zones.forEach((z, index) => {
                const rows = data.filter(r => r.ZONA === z);
                let imp = rows.reduce((acc, r) => acc + n(r['IMPORTE NETO']), 0);
                html += `<div onclick="renderSellers('${z}', '${period}')" class="bg-white rounded-3xl p-6 shadow-pro mb-4 cursor-pointer active:scale-95 transition-all border-r-4 border-yellow-500">
                    <div class="flex items-center mb-4">
                        <div class="zona-badge">${index + 1}</div>
                        <span class="text-2xl font-black text-blue-950 italic uppercase tracking-tighter">${z}</span>
                    </div>
                    <div class="border-t pt-4 border-slate-50">
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Venta Total Zona</p>
                        <p class="text-xl font-black text-blue-900">$${f(imp)}</p>
                    </div></div>`;
            });
            document.getElementById('content-area').innerHTML = html;
        }

        function renderSellers(z, period) {
            const [m, a] = period.split(' ');
            const sellers = db.filter(r => r.ZONA === z && r.MES === m && r.AÑO === a);
            let html = `<button onclick="selectMonth('${period}')" class="text-blue-900 font-black text-[10px] mb-6 uppercase flex items-center"><i class="fas fa-arrow-left mr-2"></i> Volver a Zonas</button>`;
            sellers.forEach(s => {
                html += `<button onclick="renderReport('${s.VENDEDOR}', '${period}')" class="w-full bg-white p-5 rounded-2xl shadow-pro flex items-center justify-between border-l-8 border-blue-900 mb-3 text-left">
                    <p class="font-black text-slate-800 uppercase text-sm italic">${s.VENDEDOR}</p><i class="fas fa-chevron-right text-slate-200"></i></button>`;
            });
            document.getElementById('content-area').innerHTML = html;
        }

        // REPORTE CON METAS RESALTADAS Y SIN UTILIDAD
        function renderReport(v, period) {
            const [m, a] = period.split(' ');
            const d = db.find(r => r.VENDEDOR === v && r.MES === m && r.AÑO === a);
            if (!d) return;

            const cats = [
                {n:'Premium', o:'OBJ PREMIUM', r:'REAL PREMIUM', c:'linea-pro'},
                {n:'AGM', o:'OBJ AGM', r:'REAL AGM', c:'linea-pro'},
                {n:'Estándar', o:'OBJ ESTANDAR', r:'REAL ESTANDAR', c:'linea-pro'},
                {n:'Acumuladores', o:'OBJ ACUMULADORES', r:'REAL ACUMULADORES', c:'linea-pro'},
                {n:'Lubricantes', o:'OBJ LUBRICANTES', r:'REAL LUBRICANTES', c:'linea-lub'},
                {n:'Motobaterías', o:'OBJ MOTOBATERIAS', r:'REAL MOTOBATERIAS', c:'linea-moto'},
                {n:'Filtros', o:'OBJ FILTROS', r:'REAL FILTROS', c:'linea-filt'},
                {n:'Alcalinas', o:'OBJ ALCALINAS', r:'REAL ALCALINA', c:'linea-alc'},
                {n:'Recolecciones', o:'OBJ RECOLECCIONES', r:'REAL RECOLECCIONES', c:'linea-rec'}
            ];

            let html = `<button onclick="renderSellers('${d.ZONA}', '${period}')" class="text-blue-900 font-black text-[10px] mb-6 uppercase flex items-center"><i class="fas fa-chevron-left mr-2"></i> Volver</button>
                <div class="bg-llanterama p-8 rounded-[2rem] text-white shadow-2xl mb-8 border-b-8 border-yellow-500">
                    <p class="text-[9px] font-bold text-yellow-400 uppercase tracking-widest mb-1">${period} | ${d.ZONA}</p>
                    <h3 class="text-3xl font-black mb-4 uppercase italic tracking-tighter leading-tight">${d.VENDEDOR}</h3>
                    <div class="bg-white/10 p-4 rounded-2xl text-center">
                        <p class="text-[9px] uppercase font-bold text-blue-200 tracking-widest">Importe Total Mensual</p>
                        <p class="text-3xl font-black text-yellow-400">$${f(n(d['IMPORTE NETO']))}</p>
                    </div>
                </div><div class="space-y-5">`;

            cats.forEach(c => {
                let obj = n(d[c.o]);
                let real = n(d[c.r]);
                let perc = obj > 0 ? (real / obj) * 100 : (real > 0 ? 100 : 0);
                let falta = obj - real;

                html += `
                <div class="bg-white p-6 rounded-3xl shadow-pro ${c.c} fade-in border-r-2 border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="font-black text-blue-900 uppercase text-[11px] italic mb-1 block tracking-wider">${c.n}</span>
                            <span class="text-4xl font-black ${perc >= 100 ? 'text-green-500' : 'text-blue-950'} leading-none tracking-tighter">${Math.round(perc)}%</span>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Meta del Mes</p>
                            <p class="text-2xl font-black text-blue-700 leading-none">${Math.round(obj)}</p>
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden mb-2">
                        <div class="h-full transition-all duration-1000 ${perc >= 100 ? 'bg-green-500' : 'bg-blue-600'}" style="width:${Math.min(perc, 100)}%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase text-slate-400">Vendido: ${Math.round(real)}</span>
                        ${falta > 0 ? `<span class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase italic">Faltan: ${Math.round(falta)}</span>` 
                        : `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase italic">¡Logrado!</span>`}
                    </div>
                </div>`;
            });
            document.getElementById('content-area').innerHTML = html + `</div>`;
            window.scrollTo(0,0);
        }

        function renderAnalytics() {
            let html = `<button onclick="renderPeriods()" class="text-blue-900 font-black text-[10px] mb-6 uppercase flex items-center"><i class="fas fa-arrow-left mr-2"></i> Salir</button>
                <div class="bg-white p-6 rounded-[2rem] shadow-pro mb-6 text-center">
                    <p class="text-[10px] font-black text-blue-900 uppercase mb-4 italic tracking-widest">Ventas Totales ($)</p>
                    <div style="height:250px"><canvas id="lineChart"></canvas></div>
                </div>`;
            document.getElementById('content-area').innerHTML = html;
            const anos = [...new Set(db.map(r => r.AÑO))].sort();
            const datasetsLine = anos.map((ano, i) => ({
                label: `Ventas ${ano}`,
                data: mesesRef.map(m => db.filter(r => r.MES === m && r.AÑO === ano).reduce((acc, r) => acc + n(r['IMPORTE NETO']), 0)),
                borderColor: i === 0 ? '#94a3b8' : '#003366',
                backgroundColor: i === 0 ? '#94a3b811' : '#00336611',
                fill: true, tension: 0.4
            }));
            new Chart(document.getElementById('lineChart'), { type:'line', data:{labels:mesesRef.map(m=>m.substring(0,3)), datasets:datasetsLine}, options:{responsive:true, maintainAspectRatio:false}});
        }

        function n(v) { return parseFloat(String(v || "0").replace(/[^0-9.-]+/g,"")) || 0; }
        function f(v) { return Math.round(v).toLocaleString('es-MX'); }
        start();
    </script>
</body>
</html>
